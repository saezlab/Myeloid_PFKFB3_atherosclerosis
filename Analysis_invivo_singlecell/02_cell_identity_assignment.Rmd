---
title: "Cell identify assignment for atherosclerotic plaques"
author: "Javier Perales-Pat√≥n - javier.perales@bioquant.uni-heidelberg.de"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load libraries
```{r}
suppressPackageStartupMessages(require(Seurat))
suppressPackageStartupMessages(require(GSEABase))
suppressPackageStartupMessages(require(dplyr))
suppressPackageStartupMessages(require(cowplot))
suppressPackageStartupMessages(require(ggplot2))
suppressPackageStartupMessages(require(ggrepel))
suppressPackageStartupMessages(require(genesorteR))
suppressPackageStartupMessages(require(optparse))
# Get some functions for Seurat analysis
source("../src/seurat_fx.R")
source("../src/graphics.R")
```
### Setting-up environment
The environment will be set with a random seed number for reproducibility and an output folder
for processed data and figures.

```{r env}
# Seed number
set.seed(1234)
# Output directory
OUTDIR <- "./output/02_assignment"
if(!dir.exists(OUTDIR)) dir.create(OUTDIR);
# Input data
sobj <- "./output/01_integration/S.rds"
```


## Load data
Read the Seurat Object from first step.
```{r load_seurat}
if(file.exists(sobj)) {
	S <- readRDS(sobj)
} else {
	stop("ERROR: Seurat object does not exist. Run 01.rmd to generate it.")
}
```

## Cell identity
Immune cells are defined by expression of Prtcpr, 
while non-immune cells such as mesenchymal cells are so by collagen genes.

```{r umap_immune, dpi=300, fig.path="./output/02_assignment/", dev=c('png','tiff')}
# FeaturePlot(S, features = "Ptprc", label = TRUE, label.size = 14)
VlnPlot(S, features="Ptprc")
```
```{r umap_nonimmune, fig.width=14, fig.height=6, dpi=300, fig.path="./output/02_assignment/", dev=c('png','tiff')}
FeaturePlot(S, features = c("Col3a1", "Col14a1"), label = TRUE, label.size = 14)
# VlnPlot(S, features=c("Col3a1", "Col14a1"))
```

Macrophages are characterized by expression of CD68

```{r umap_cd68, dpi=300, fig.path="./output/02_assignment/", dev=c('png','tiff')}
VlnPlot(S, features="Cd68")
```
Fibroblasts express Pdgfra and Smoc2, these are further characterized later.
```{r umap_markers_unk, fig.width=14, fig.height=6, dpi=300, fig.path="./output/02_assignment/", dev=c('png','tiff')}
FeaturePlot(S, features = c("Pdgfra","Smoc2"), label = TRUE, label.size = 14)
```

And SMC express Acta2, which are further characterized later.
```{r}
VlnPlot(S, features = c("Acta2"))
```

Thus we can conclude with the stratification
```{r}
S$immune <- Idents(S) %in% c("1","3","6","7","8")
S$Cd68 <- Idents(S) %in% c("1", "3", "8")
```

Finally we conclude showing the expresion of a consensus set of markers (from previous step, see 01.Rmd) 
for each cell type in the biological context. And assign cell type identities for each cluster.

```{r heatmap_consensus, fig.width=14, fig.height=10, dpi=300, fig.path="./output/02_assignment/", dev=c('png','tiff')}
DoHeatmap3(SeuratObject = S, GSC = getGmt("../data/markers/consensus.gmt"), 
	   assay = "RNA", res=NULL, row_names_size=12, show_hr=FALSE)
```


```{r}
ren_id <- c("0"="Fibroblast",
"1"="Macrophage",
"2"="EC1",
"3"="Neutrophil",
"4"="SMC",
"5"="EC2",
"6"="B-Cell",
"7"="T-Cell",
"8"="n.a."
)
S <- RenameIdents(S, ren_id)
```

We show the UMAP plot for publishing
```{r umap_plot, dpi=300, fig.path="./output/02_assignment/", dev=c('png','tiff')}
#geom_text <- function(...) geom_text(..., family="Calibri")
#geom_repel <- function(...) geom_repel(..., family="Calibri")
update_geom_defaults("text", list(family=fontTXT))
DimPlot(S, reduction = "umap", label = TRUE, label.size = 9) + 
	theme(text=element_text(family=fontTXT),
	      axis.text=element_text(family=fontTXT, size=20),
	      axis.title=element_text(family=fontTXT, size=20)
	)
```

```{r umap_condition, dpi=300, fig.path="./output/02_assignment/", dev=c('png','tiff')}
DimPlot(S, reduction = "umap", cols = c("grey","red"), group.by="stim", label = FALSE) + 
	theme(text=element_text(family=fontTXT),
	      axis.text=element_text(family=fontTXT, size=20),
	      axis.title=element_text(family=fontTXT, size=20)
	)
```

```{r vln_Egln1, dpi=300, fig.path="./output/02_assignment/", dev=c('png','tiff')}
vln1 <- VlnPlot(S[,Idents(S) %in% c("Macrophage","Fibroblast") & S$stim=="PHD2cKO"], feature="Egln1") 
vln2 <- VlnPlot(S[,Idents(S) %in% c("Macrophage","Fibroblast") & S$stim=="WT"], feature="Egln1") 
CombinePlots(list(vln1,vln2), ncol = 1)
```

## Save the Seurat Object
```{r seurat_obj}
saveRDS(S, paste0(OUTDIR,"/S.rds"));
```

## SessionInfo
```{r}
sessionInfo()

{                                                                                                                                                                                                           
sink(file=paste0(OUTDIR,"/sessionInfo.txt"))
print(sessionInfo())
sink()
}
```





